/*
 * history API JavaScript Library v3.0.1 beta
 *
 * Support: IE6+, FF3+, Opera 9+, Safari, Chrome
 *
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 18-05-2012
 */
(function(e,Y,w,r,U){function G(a,d,f){var c=2===a?e.onhashchange:e.onpopstate,b=2===a?"hashchange":"popstate",m=u[b];o.createEvent?(a=o.createEvent("Events"),a.initEvent(b,w,w)):(a=o.createEventObject(),a.type=b);a.state=n.state;a.oldURL=d;a.newURL=f;c&&c.call(e,a);d=0;for(f=m.length;d<f;d++)m[d].call(e,a)}function N(a){return H?a?H.setItem("__hitoryapi__",I(a)):O(H.getItem("__hitoryapi__"))||{}:{}}function O(a){return a?P?P(a):(new Function("return "+a))():r}function Q(a,d,f){var c=a,b,m=0;if(x||
y)for(b in d){if(z.call(d,b))if(y)d[b].get&&y.call(a,b,d[b].get),d[b].set&&Z.call(a,b,d[b].set);else if(x)try{x(a,b,d[b])}catch(h){if(f)return 0;m=1;break}}else m=1;if(m&&A){f="StaticClass"+$+A++;c=["Class "+f];m=0;"execVB"in e||execScript("Public history, onhashchange\nFunction execVB(c) ExecuteGlobal(c) End Function","VBScript");"VBCVal"in e||execScript("Function VBCVal(o,r) If IsObject(o) Then Set r=o Else r=o End If End Function","VBScript");for(b in a)"toString"===b&&(m=1),c[c.length]="Public ["+
b+"]";z.call(a,"toString")&&(m||(c[c.length]="Public [toString]"),d["(toString)"]={get:function(){return this.toString.call(this)}});for(b in d)if(z.call(d,b)&&(d[b].get&&(a["get "+b]=d[b].get,c.push("Public [get "+b+"]","Public "+("(toString)"===b?"Default ":"")+"Property Get ["+b+"]","Call VBCVal(me.[get "+b+"].call(me),["+b+"])\nEnd Property")),d[b].set))a["set "+b]=d[b].set,m="Call me.[set "+b+"].call(me,v)\nEnd Property",c.push("Public [set "+b+"]","Public Property Let ["+b+"](v)",m,"Public Property Set ["+
b+"](v)",m);c.push("End Class","Function "+f+"Factory()","Set "+f+"Factory=New "+f,"End Function");execVB(c.join("\n"));c=e[f+"Factory"]();for(b in a)c[b]=a[b];z.call(a,"toString")&&(c.toString=a.toString)}return c}function j(a){var d,f,c=g.href.split("#");d=(c.shift(),"#"+c.join("#"));var c=(d||"#").replace(RegExp("^#[/]?(?:"+p.type+")?"),""),b=(d=c.split("#")).shift(),e=p.basepath+c,h=(f=(p.basepath+b).split("?")).shift(),j=f.join("?");d=(0<d.length?"#":"")+d.join("#");f=a&&a.substring(0,1);var l=
g.protocol+"//"+g.host,i=l;a&&(h=k?g.pathname:h,i=/[a-z]+\:\/\//.test(a)?a:"/"===f?i+a:"?"===f?i+((0===h.indexOf("/")?"":"/")+h+a):"#"===f?(k?g.href:l+e).split("#").shift()+a:i+((0===h.indexOf("/")?"":"/")+h.replace(/[^\/]+$/g,"")+a));f=RegExp("^"+l+p.basepath+"(.*)","i").exec(a?i:l+e);return{e:c,c:p.type+b,href:e,pathname:h,search:j?"?"+j:"",hash:d,a:l+e,d:i,b:f&&f[1]||""}}var C,D,E,J="",o=e.document,q=e.history||{},g=e.location,k=!!q.pushState,aa=k&&q.state===U,s=g.href,V=q.pushState,W=q.replaceState,
F=e.JSON||{},P=F.parse,R=F.stringify,H=e.sessionStorage,x=Object.defineProperty,y=Object.prototype.__defineGetter__,Z=Object.prototype.__defineSetter__,z=Object.prototype.hasOwnProperty,ba=Object.prototype.toString,K=(C="addEventListener",e[C])||(C="attachEvent",J="on",e[C]),ca=(D="removeEventListener",e[D])||(D="detachEvent",e[D]),da=(E="dispatchEvent",e[E])||(E="fireEvent",e[E]),v=eval("/*@cc_on (@_jscript_version+'').replace(/\\d\\./, '');@*/"),$=(new Date).getTime(),A=(x||y)&&(!v||8<v)?0:1,i=
8>v?o.createElement("iframe"):0,L=[],v=[],S=0,u={onpopstate:L,popstate:L,onhashchange:v,hashchange:v},p=function(){var a,d,f,c={basepath:"/",redirect:0,type:"/"};f=o.getElementsByTagName("SCRIPT");for(a=0;f[a];a++)if(d=/(.*)\/(?:history|spike)(?:-\d\.\d(?:\.\d)?\w?)?(?:\.min)?.js\?(.*)$/i.exec(f[a].src)){a=0;for(f=d[2].split("&");f[a];)d=f[a++].split("="),c[d[0]]="true"==d[1]?1:"false"==d[1]?0:d[1]||"";break}return c}(),n=!A?q:{back:q.back,forward:q.forward,go:q.go,pushState:0,replaceState:0,emulate:!k,
toString:function(){return"[object History]"}},M={state:{get:function(){return i&&i.storage||N()[n.location.href]||r}},length:{get:function(){return q.length}},location:{set:function(a){e.location=a},get:function(){return k?g:T}}},T={assign:function(a){g.assign(k||0!==a.indexOf("#")?a:"#"+j().c+a)},reload:g.reload,replace:function(a){g.replace(k||0!==a.indexOf("#")?a:"#"+j().c+a)},toString:function(){return this.href}},ea={href:{set:function(a){g.href=a},get:function(){return j().a}},protocol:{set:function(a){g.protocol=
a},get:function(){return g.protocol}},host:{set:function(a){g.host=a},get:function(){return g.host}},hostname:{set:function(a){g.hostname=a},get:function(){return g.hostname}},port:{set:function(a){g.port=a},get:function(){return g.port}},pathname:{set:function(a){g.pathname=a},get:function(){return j().pathname}},search:{set:function(a){g.search=a},get:function(){return j().search}},hash:{set:function(a){var a=0===a.indexOf("#")?a:"#"+a,d=j();i?a!=d.hash&&(n.pushState(0,0,d.c+a),X({oldURL:d.a})):
g.hash="#"+d.c+a},get:function(){return j().hash}}},I=function(a){function d(a){var b=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};b.lastIndex=0;return b.test(a)?'"'+a.replace(b,function(a){var b=d[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function f(c){var b,e,h;b=(typeof c).charCodeAt(2);
if(114===b)c=d(c);else if(109===b)c=isFinite(c)?""+c:"null";else if(111===b||108===b)c=""+c;else if(106===b)if(c){e=(b="[object Array]"===ba.apply(c))?"[":"{";if(b)for(h=0;h<c.length;h++)e+=(0==h?"":",")+f(c[h]);else for(h in c)z.call(c,h)&&c[h]!==a&&(e+=(1==e.length?"":",")+d(h)+":"+f(c[h]));c=e+(b?"]":"}")}else c="null";else c=a;return c}return R?R:f}(),X=function(){function a(a){if(S)return h=j().a,S=0;var d=a.oldURL||h,a=h=a.newURL||n.location.href,c=d.replace(/^.*?(#|$)/,""),e=a.replace(/^.*?(#|$)/,
"");d!=a&&!b&&G();s=b=0;c!=e&&G(2,d,a)}function d(){if(s&&!(s=0)&&j().href!==p.basepath)clearInterval(i),setTimeout(G,10)}var f=e.onpopstate||r,c=e.onhashchange||r,b=0,i=r,h=k?g.href:j().a;(k?g.hash:j().hash).replace(/^#/,"");K(J+"hashchange",a,w);K(J+"popstate",function(){if(s===g.href)return s=0;s=0;G(b=1)},w);n=Q(n,A?M:q.state===U?{state:M.state,location:M.location}:{location:M.location});T=Q(T,ea);e[C]=function(a,b,c,e){u[a]?(u[a].push(b),!k&&L===u[a]&&d()):K(a,b,c,e)};e[D]=function(a,b,d){var c=
u[a];if(c)for(a=c.length;--a;){if(c[a]===b){c.splice(a,1);break}}else ca(a,b,d)};e[E]=function(a,b){var d=u[a],c=d===L?e.onpopstate:e.onhashchange;if(d){b=b||("string"==typeof a?e.event:a);try{b&&(b.target=e)}catch(f){try{b.srcElement=e}catch(h){}}c&&c.call(e,b);for(var c=0,g=d.length;c<g;c++)d[c].call(e,b);return Y}return da(a,b)};if((!x&&!y||!Q(e,{onhashchange:{get:function(){return c},set:function(a){c=a||r}},onpopstate:{get:function(){return f},set:function(a){(f=a||r)&&!k&&d()}}},1))&&!k)i=setInterval(function(){e.onpopstate&&
d()},100);if(p.redirect&&0===e.parent.frames.length){var o=j(),l=g.search,B=g.pathname,t=p.basepath;if(k){if(o.href!=t&&RegExp("^"+t+"$","i").test(B)&&(g.href=o.href),!RegExp("^"+t,"i").test(B))g.href=B.replace(/^\//,t)+l}else B!=t&&(g.href=t+"#"+B.replace(RegExp("^"+t,"i"),p.type)+l+g.hash)}!P&&!R&&(F.parse=O,F.stringify=I,e.JSON=F);return a}();n.pushState=function(a,d,e,c){var b=N(),i=n.location.href,h=e&&j(e);s=0;e=h?h.d:i;c&&b[i]&&delete b[i];if((!k||aa)&&H&&a)b[e]=a,N(b),a=r;V&&W?c?W.call(n,
a,d,e):V.call(n,a,d,e):h&&h.b!=j().b&&(S=1,c?g.replace("#"+p.type+h.b):g.hash=p.type+h.b)};n.replaceState=function(a,d,e){n.pushState(a,d,e,1)};A?(e.history=n,function(a,d){if(i){var e,c,b=function(){var a=j().a;d!=a&&X({oldURL:d,newURL:d=a})};c=setInterval(b,100);i.src="javascript:true;";i=o.documentElement.firstChild.appendChild(i).contentWindow;n.pushState=e=function(a,k,l,n,m){var o=i.document,q=["<script>","lfirst=1;",,"storage="+I(a)+";","<\/script>"],l=l&&j(l);if(!l||!l.b)i.storage=a;else{m||
clearInterval(c);if(n)i.lfirst?(history.back(),e(a,k,l.d,0,1)):(i.storage=a,g.replace("#"+p.type+l.b));else if(l.d!=d||m)i.lfirst||(i.lfirst=1,e(i.storage,k,d,0,1)),q[2]='parent.location.hash="'+(p.type+l.b).replace(/"/g,'\\"')+'";',o.open(),o.write(q.join("")),o.close();m||(d=j().a,c=setInterval(b,100))}};K(J+"unload",function(){if(i.storage){var a={};a[j().a]=i.storage;o.cookie="_historyAPI="+escape(I(a))}clearInterval(c)},w);if(1<a.length){a=unescape(a.pop().split(";").shift());try{i.storage=O(a)[j().a]}catch(k){}}}}(o.cookie.split("_historyAPI="),
j().a)):e.history.emulate=!k})(window,!0,!1,null);
