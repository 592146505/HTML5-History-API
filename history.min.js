/*
 * history API JavaScript Library v3.1.0 beta
 *
 * Support: IE6+, FF3+, Opera 9+, Safari, Chrome
 *
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 20-05-2012
 */
(function(e,G,s,p,T){function H(a,c,g){var d=2===a?e.onhashchange:e.onpopstate,b=2===a?"hashchange":"popstate",f=x[b];t.createEvent?(a=t.createEvent("Events"),a.initEvent(b,s,s)):(a=t.createEventObject(),a.type=b);a.state=m.state;a.oldURL=c;a.newURL=g;d&&d.call(e,a);c=0;for(g=f.length;c<g;c++)f[c].call(e,a)}function O(a){return I?a?I.setItem("__hitoryapi__",J(a)):P(I.getItem("__hitoryapi__"))||{}:{}}function Q(a,c,g){var d=a,b,f=s;if(A||B)for(b in c){if(C.call(c,b))if(B)c[b].get&&B.call(a,b,c[b].get),
c[b].set&&Z.call(a,b,c[b].set);else if(A)try{A(a,b,c[b])}catch(h){if(g)return s;f=G;break}}else f=G;if(f&&y){g="StaticClass"+$+y++;d=["Class "+g];"execVB"in e||execScript("Function execVB(c) ExecuteGlobal(c) End Function","VBScript");"VBCVal"in e||execScript("Function VBCVal(o,r) If IsObject(o) Then Set r=o Else r=o End If End Function","VBScript");for(b in a)d[d.length]="Public ["+b+"]";C.call(a,"toString")&&(a.propertyIsEnumerable("toString")||(d[d.length]="Public [toString]"),c["(toString)"]={get:function(){return this.toString.call(this)}});
for(b in c)if(C.call(c,b)&&(c[b].get&&(a["get "+b]=c[b].get,d.push("Public [get "+b+"]","Public "+("(toString)"===b?"Default ":"")+"Property Get ["+b+"]","Call VBCVal(me.[get "+b+"].call(me),["+b+"])","End Property")),c[b].set))a["set "+b]=c[b].set,d.push("Public [set "+b+"]","Public Property Let ["+b+"](v)","Call me.[set "+b+"].call(me,v)","End Property","Public Property Set ["+b+"](v)","Call me.[set "+b+"].call(me,v)","End Property");d.push("End Class","Function "+g+"Factory()","Set "+g+"Factory=New "+
g,"End Function");execVB(d.join("\n"));d=e[g+"Factory"]();for(b in a)d[b]=a[b];C.call(a,"toString")&&(d.toString=a.toString)}return d}var t=e.document,r=e.history||{},f=e.location,k=!!r.pushState,aa=k&&r.state===T,v=f.href,w=e.JSON||{},A=Object.defineProperty,B=Object.prototype.__defineGetter__,Z=Object.prototype.__defineSetter__,U=r.pushState,V=r.replaceState,I=e.sessionStorage,C=Object.prototype.hasOwnProperty,ba=Object.prototype.toString,z=eval("/*@cc_on (@_jscript_version+'').replace(/\\d\\./, '');@*/"),
$=(new Date).getTime(),y=(A||B)&&(!z||8<z)?0:1,i=8>z?t.createElement("iframe"):s,D,E,F,K="",L=(D="addEventListener",e[D])||(D="attachEvent",K="on",e[D]),ca=(E="removeEventListener",e[E])||(E="detachEvent",e[E]),da=(F="dispatchEvent",e[F])||(F="fireEvent",e[F]),M=[],z=[],R=0,x={onpopstate:M,popstate:M,onhashchange:z,hashchange:z},u=function(){var a,c,g,d={basepath:"/",redirect:0,type:"/"};g=t.getElementsByTagName("SCRIPT");for(a=0;g[a];a++)if(c=/(.*)\/(?:history|spike)(?:-\d\.\d(?:\.\d)?\w?)?(?:\.min)?.js\?(.*)$/i.exec(g[a].src)||
a===g.length-1&&2===(c=g[a].src.split("?")).length&&(c[2]=c[1])&&c){a=0;for(g=c[2].split("&");g[a];)c=g[a++].split("="),d[c[0]]="true"==c[1]?G:"false"==c[1]?s:c[1]||"";d.basepath=d.basepath||"/";break}return d}(),l=function(a){var c,g,d,b,e,h,q,i=RegExp("^"+u.basepath,"i");return function(j){if(j){if(!k)var o=l(),n=o.f,X=o.i,j=/^(?:[a-z]+\:)?\/\//.test(j)?0===j.indexOf("/")?X+j:j:X+"//"+o.h+(0===j.indexOf("/")?j:0===j.indexOf("?")?n+j:0===j.indexOf("#")?n+o.g+j:n.replace(/[^\/]+$/g,"")+j)}else j=
f.href,k||(j=f.protocol+"//"+f.host+u.basepath+(j.replace(/^[^#]*/,"")||"#").replace(RegExp("^#[/]?(?:"+u.type+")?"),""));if(c!==j){a.href=c=j;h=a.port;e=a.host;q=a.pathname;if("http:"===a.protocol&&80==h||"https:"===a.protocol&&443==h)e=a.hostname,h="";q=0===q.indexOf("/")?q:"/"+q;g=q+a.search+a.hash;b=q.replace(i,u.type)+a.search;d=b+a.hash}return{a:a.protocol+"//"+e+g,i:a.protocol,h:e,j:a.hostname||f.hostname,k:h||f.port,f:q,g:a.search,e:a.hash,b:g,c:b,d:d}}}(t.createElement("a")),m=!y?r:{back:r.back,
forward:r.forward,go:r.go,pushState:p,replaceState:p,emulate:!k,toString:function(){return"[object History]"}},N={state:{get:function(){return i&&i.storage||O()[m.location.href]||p}},length:{get:function(){return r.length}},location:{set:function(a){e.location=a},get:function(){return k?f:S}}},S={assign:function(a){f.assign(k||0!==a.indexOf("#")?a:"#"+l().c+a)},reload:f.reload,replace:function(a){f.replace(k||0!==a.indexOf("#")?a:"#"+l().c+a)},toString:function(){return this.href}},ea={href:{set:function(a){f.href=
a},get:function(){return l().a}},protocol:{set:function(a){f.protocol=a},get:function(){return f.protocol}},host:{set:function(a){f.host=a},get:function(){return f.host}},hostname:{set:function(a){f.hostname=a},get:function(){return f.hostname}},port:{set:function(a){f.port=a},get:function(){return f.port}},pathname:{set:function(a){f.pathname=a},get:function(){return l().f}},search:{set:function(a){f.search=a},get:function(){return l().g}},hash:{set:function(a){var a=0===a.indexOf("#")?a:"#"+a,c=
l();i?a!=c.e&&(m.pushState(p,p,c.c+a),Y({oldURL:c.a})):f.hash="#"+c.c+a},get:function(){return l().e}}},J=w.stringify||function(a){function c(d){var b,e,h;b=(typeof d).charCodeAt(2);if(114===b)d=g(d);else if(109===b)d=isFinite(d)?""+d:"null";else if(111===b||108===b)d=""+d;else if(106===b)if(d){e=(b="[object Array]"===ba.apply(d))?"[":"{";if(b)for(h=0;h<d.length;h++)e+=(0==h?"":",")+c(d[h]);else for(h in d)C.call(d,h)&&d[h]!==a&&(e+=(1==e.length?"":",")+g(h)+":"+c(d[h]));d=e+(b?"]":"}")}else d="null";
else d=a;return d}function g(a){var b=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};b.lastIndex=0;return b.test(a)?'"'+a.replace(b,function(a){var b=c[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}return c}(),P=function(){var a=w.parse;return function(c){return c?a?a(c):(new Function("return "+
c))():p}}(),Y=function(){function a(a){var c=l();if(R)return q=c.a,R=0;var d=a.oldURL||q,a=q=a.newURL||c.a,c=d.replace(/^.*?(#|$)/,""),e=a.replace(/^.*?(#|$)/,"");d!=a&&!b&&H();v=b=0;c!=e&&H(2,d,a)}function c(){if(v&&!(v=0)&&h.b!==u.basepath)clearInterval(i),setTimeout(H,10)}var g=e.onpopstate||p,d=e.onhashchange||p,b=0,i=p,h=l(),q=h.a;h.e.replace(/^#/,"");L(K+"hashchange",a,s);L(K+"popstate",function(){if(v===f.href)return v=0;v=0;H(b=1)},s);m.fixURL=function(a){return l(a).b};m=Q(m,y?N:r.state===
T?{state:N.state,location:N.location}:{location:N.location});S=Q(S,ea);e[D]=function(a,b,d,e){x[a]?(x[a].push(b),!k&&M===x[a]&&c()):L(a,b,d,e)};e[E]=function(a,b,c){var d=x[a];if(d)for(a=d.length;--a;){if(d[a]===b){d.splice(a,1);break}}else ca(a,b,c)};e[F]=function(a,b){var c=x[a],d=c===M?e.onpopstate:e.onhashchange;if(c){b=b||("string"==typeof a?e.event:a);try{b&&(b.target=e)}catch(g){try{b.srcElement=e}catch(h){}}d&&d.call(e,b);for(var d=0,f=c.length;d<f;d++)c[d].call(e,b);return G}return da(a,
b)};y&&execScript("Public history, onhashchange","VBScript");if((!A&&!B||!Q(e,{onhashchange:{get:function(){return d},set:function(a){d=a||p}},onpopstate:{get:function(){return g},set:function(a){(g=a||p)&&!k&&c()}}},1))&&!k)i=setInterval(function(){e.onpopstate&&c()},100);if(u.redirect&&0===e.parent.frames.length){var W=l().b,j=f.search,o=f.pathname,n=u.basepath;if(k){if(W!=n&&RegExp("^"+n+"$","i").test(o)&&(f.href=W),!RegExp("^"+n,"i").test(o))f.href=o.replace(/^\//,n)+j}else o!=n&&(f.href=n+"#"+
o.replace(RegExp("^"+n,"i"),u.type)+j+f.hash)}return a}();m.pushState=function(a,c,e,d){var b=O(),i=l().a,h=e&&l(e);v=0;e=h?h.a:i;d&&b[i]&&delete b[i];if((!k||aa)&&I&&a)b[e]=a,O(b),a=p;U&&V?d?V.call(m,a,c,e):U.call(m,a,c,e):h&&h.b!=l().b&&(R=1,d?f.replace("#"+h.d):f.hash=h.d)};m.replaceState=function(a,c,e){m.pushState(a,c,e,1)};y?(e.history=m,function(a,c){if(i){var g,d,b=function(){var a=l().a;c!=a&&Y({oldURL:c,newURL:c=a})};d=setInterval(b,100);i.src="javascript:true;";i=t.documentElement.firstChild.appendChild(i).contentWindow;
m.pushState=g=function(a,e,k,j,o){var n=i.document,m=["<script>","lfirst=1;",,"storage="+J(a)+";","<\/script>"];if(k=k&&l(k)){o||clearInterval(d);if(j)i.lfirst?(history.back(),g(a,e,k.a,0,1)):(i.storage=a,f.replace("#"+k.d));else if(k.a!=c||o)i.lfirst||(i.lfirst=1,g(i.storage,e,c,0,1)),m[2]='parent.location.hash="'+k.d.replace(/"/g,'\\"')+'";',n.open(),n.write(m.join("")),n.close();o||(c=l().a,d=setInterval(b,100))}else i.storage=a};L(K+"unload",function(){if(i.storage){var a={};a[l().a]=i.storage;
t.cookie="_historyAPI="+escape(J(a))}clearInterval(d)},s);if(1<a.length){a=unescape(a.pop().split(";").shift());try{i.storage=P(a)[l().a]}catch(k){}}!w.parse&&!w.stringify&&(w.parse=P,w.stringify=J,e.JSON=w)}}(t.cookie.split("_historyAPI="),l().a)):e.history.emulate=!k})(window,!0,!1,null);
