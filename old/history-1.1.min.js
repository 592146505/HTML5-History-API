/*
 * history API JavaScript Library v1.1
 *
 * Copyright 2011, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 20-12-2011
 */
(function(d,z){function A(){var a=e.location.pathname;if(s){if(h!=g.basepath&&RegExp("^"+g.basepath+"$").test(a))e.location=h;if(!RegExp("^"+g.basepath).test(e.location.pathname))e.location=a.replace(/^\//,g.basepath)+e.location.search}else if(a!=g.basepath)e.location=g.basepath+"#"+a.replace(RegExp("^"+g.basepath),"/")+e.location.search+e.location.hash;return true}var s=!!(d.history&&history.pushState),e=d.document,i=null,o=false,u=true,p=[],h,r=function(a){return{url:(a||e.location.hash||"#").replace(/^#[\/]?/,
"/"),full:function(){return this.url.replace(/^\//,g.basepath)}}},g=function(){var a,b,c,f={basepath:"/",redirect:true};c=e.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){a=0;for(c=b[2].split("&");c[a];){b=c[a++].split("=");f[b[0]]=b[1]=="true"?true:b[1]=="false"?false:b[1]||""}break}if(!d.history)d.history={};i=d.history;return f}();h=r().full();if((!g.redirect||A())&&!s){i.historyAPI=s;var l=function(){for(var a=3,b=
e.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return a>4?a:false}(),n=Boolean(l);if(n&&l<8){var B=function(a){function b(f){var k=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,q={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};k.lastIndex=0;return k.test(f)?'"'+f.replace(k,function(m){var v=q[m];return typeof v===
"string"?v:"\\u"+("0000"+m.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function c(f){var k,q;switch(typeof f){case "string":return b(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";q=(k=Object.prototype.toString.apply(f)==="[object Array]")?"[":"{";for(var m in f)k&&~~m!=m||!Object.hasOwnProperty.call(f,m)||(q+=(q.length==1?"":",")+(!k&&b(m)+":"||"")+c(f[m]));return q+(k?"]":"}")}return null}return c(a)},j;
e.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');j=e.getElementById("APIHistoryFrame").contentWindow;var w=function(a,b){if(a!=j.curHash){j.document.open();j.document.write('<script>window.curHash="'+a+'";parent.location.hash="'+a+'";window.storage='+B(b)+";<\/script>");j.document.close()}};getIframeHash=function(){return(j.curHash||"/").replace(/^\//,g.basepath)};j.curHash=r().url;j.storage=null}var C=d.addEventListener?d.addEventListener:d.attachEvent||
function(){},D=d.removeEventListener?d.removeEventListener:d.detachEvent||function(){},E=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},t=function(a,b,c){if(a==="popstate"||a==="onpopstate"){p.push(b);if(u&&!(u=false)&&h!==g.basepath&&g.redirect)setTimeout(function(){firePopState.call(d,generateLocation(h))},10)}else C(a,b,c)},x=function(a,b,c){if(a==="popstate"||a==="onpopstate"){a=0;for(c=p.length;a<c;a++)if(p[a]===b){p.splice(a,1);break}}else D(a,b,c)},y=function(a,b){var c=!b&&a.type||
a;if(c==="popstate"||c==="onpopstate")for(c=p.length;0<c;){if(b=b||(typeof a=="string"?d.event:a))try{b.target=d}catch(f){try{b.srcElement=d}catch(k){}}return p[0].call(d,b)}else return E(a,b)};if(d.addEventListener){d.addEventListener=t;d.removeEventListener=x;d.dispatchEvent=y}else{d.attachEvent=t;d.detachEvent=x;d.fireEvent=y}generateLocation=function(a){var b,c,f;f=(b=a.split("?")).shift();b=(c=b.join("?").split("#")).shift();c=c.join("#");return{hash:c?"#"+c:"",host:e.location.host,hostname:e.location.hostname,
href:e.location.protocol+"//"+e.location.host+a,pathname:f,port:e.location.port,protocol:e.location.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=function(a){i.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(h);i.state=d.JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}else if(n&&l<8)i.state=j.storage;if(e.createEvent){b=e.createEvent("Events");b.initEvent("popstate",false,false);b.location=a;b.state=i.state;b.srcElement=d;d.dispatchEvent(b)}else if(e.createEventObject){b=
e.createEventObject();b.srcElement=d;b.location=a;b.state=i.state;b.type="popstate";d.fireEvent("popstate",b)}};hashChecker=function(){if(o)return false;o=true;var a=r().full();if(h!==a){h=a;firePopState(generateLocation(a))}else if(n&&l<8){a=getIframeHash();if(h!==a){h=a;e.location.hash=h;firePopState(generateLocation(a))}}o=false;return true};n&&l<8?setInterval(hashChecker,100):t((d.addEventListener?"":"on")+"hashchange",hashChecker,false);i.pushState=function(a,b,c,f){c=c==z||c==null?g.basepath:
c;(b=generateLocation(r().full()).pathname.split("/")).pop();if(f)if(d.sessionStorage&&d.JSON&&JSON.stringify)sessionStorage.setItem(h,JSON.stringify(a));else{if(n&&l<8)j.storage=a}else{for(;o;);o=true;c=c.replace(RegExp("^"+e.location.protocol+"//"+e.location.hostname+"/"),"/");b=b.join("/")+"/";if(c.indexOf("/")<0){e.location.hash=b+c;n&&l<8&&w(b+c,a)}else if(RegExp("^"+g.basepath).test(c)){c=c.replace(RegExp("^"+g.basepath),"/");e.location.hash=c;n&&l<8&&w(c,a)}else e.location=c;h=r().full();d.sessionStorage&&
d.JSON&&JSON.stringify&&a!=null&&sessionStorage.setItem(h,JSON.stringify(a));o=false}};i.replaceState=function(a,b,c){i.pushState(a,b,c,true)}}})(window);
