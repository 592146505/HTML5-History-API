/*
 * history API JavaScript Library v1.2.2
 *
 * Copyright 2011, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 28-12-2011
 */
(function(d,y){function z(){var a=e.location.pathname;if(s){if(l!=h.basepath&&RegExp("^"+h.basepath+"$").test(a))e.location=l;if(!RegExp("^"+h.basepath).test(e.location.pathname))e.location=a.replace(/^\//,h.basepath)+e.location.search}else if(a!=h.basepath)e.location=h.basepath+"#"+a.replace(RegExp("^"+h.basepath),"/")+e.location.search+e.location.hash;return true}var s=!!(d.history&&history.pushState),e=d.document,g=null,p=false,u=true,q=[],l,n=function(a){return{url:(a||e.location.hash||"#").replace(/^#[\/]?/,
"/"),full:function(){return this.url.replace(/^\//,h.basepath)}}},h=function(){var a,b,c,f={basepath:"/",redirect:true};c=e.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){a=0;for(c=b[2].split("&");c[a];){b=c[a++].split("=");f[b[0]]=b[1]=="true"?true:b[1]=="false"?false:b[1]||""}break}if(!d.history)d.history={};g=d.history;return f}();l=n().full();if((!h.redirect||z())&&!s){g.historyAPI=s;var o=function(){for(var a=3,b=
e.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return a>4?a:false}(),r=Boolean(o);if(r&&o<8){var A=function(a){function b(f){var i=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};i.lastIndex=0;return i.test(f)?'"'+f.replace(i,function(m){var v=j[m];return typeof v===
"string"?v:"\\u"+("0000"+m.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function c(f){var i,j;switch(typeof f){case "string":return b(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";j=(i=Object.prototype.toString.apply(f)==="[object Array]")?"[":"{";for(var m in f)i&&~~m!=m||!Object.hasOwnProperty.call(f,m)||(j+=(j.length==1?"":",")+(!i&&b(m)+":"||"")+c(f[m]));return j+(i?"]":"}")}return null}return c(a)},k;
e.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');k=e.getElementById("APIHistoryFrame").contentWindow;getIframeHash=function(){return(k.curHash||"/").replace(/^\//,h.basepath)};k.curHash=n().url;k.storage=null}var B=d.addEventListener?d.addEventListener:d.attachEvent||function(){},C=d.removeEventListener?d.removeEventListener:d.detachEvent||function(){},D=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},t=function(a,b,c){if(a==="popstate"||a===
"onpopstate"){q.push(b);if(u&&!(u=false)&&l!==h.basepath&&h.redirect)setTimeout(function(){firePopState.call(d,generateLocation(l))},10)}else B(a,b,c)},w=function(a,b,c){if(a==="popstate"||a==="onpopstate"){a=0;for(c=q.length;a<c;a++)if(q[a]===b){q.splice(a,1);break}}else C(a,b,c)},x=function(a,b){var c=!b&&a.type||a;if(c==="popstate"||c==="onpopstate"){b=b||(typeof a=="string"?d.event:a);c=0;for(var f=q.length;c<f;c++){if(b)try{b.target=d}catch(i){try{b.srcElement=d}catch(j){}}q[c].call(d,b)}}else return D(a,
b)};if(d.addEventListener){d.addEventListener=t;d.removeEventListener=w;d.dispatchEvent=x}else{d.attachEvent=t;d.detachEvent=w;d.fireEvent=x}generateLocation=function(a){var b,c,f;f=(b=a.split("?")).shift();b=(c=b.join("?").split("#")).shift();c=c.join("#");return{hash:c?"#"+c:"",host:e.location.host,hostname:e.location.hostname,href:e.location.protocol+"//"+e.location.host+a,pathname:f,port:e.location.port,protocol:e.location.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=
function(a){g.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(l);g.state=d.JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}else if(r&&o<8)g.state=k.storage;g.title=g.state?g.state.title:null;g.state=g.state?g.state.state:null;if(g.title!=null)e.title=g.title;if(e.createEvent){b=e.createEvent("Events");b.initEvent("popstate",false,false);b.location=a;b.state=g.state;b.title=g.title;b.srcElement=d;d.dispatchEvent(b)}else if(e.createEventObject){b=e.createEventObject();b.srcElement=
d;b.location=a;b.state=g.state;b.title=g.title;b.type="popstate";d.fireEvent("popstate",b)}};hashChecker=function(){if(p)return false;p=true;var a=n().full();if(l!==a){l=a;firePopState(generateLocation(a))}p=false;return true};r&&o<8?setInterval(hashChecker,100):t((d.addEventListener?"":"on")+"hashchange",hashChecker,false);g.pushState=function(a,b,c,f){c=c==y||c==null?h.basepath:c;var i=d.sessionStorage&&d.JSON&&JSON.stringify,j;(j=generateLocation(n().full()).pathname.split("/")).pop();a={state:a,
title:b};c=c.replace(RegExp("^"+e.location.protocol+"//"+e.location.hostname+"/"),"/");for(j=j.join("/")+"/";p;);p=true;if(c.indexOf("/")<0)c=j+c;else if(RegExp("^"+h.basepath).test(c))c=c.replace(RegExp("^"+h.basepath),"/");else e.location=c;if(f){e.location.replace("#"+c);if(r&&o<8)k.curHash=c;if(i){sessionStorage.removeItem(l);sessionStorage.setItem(n().full(),JSON.stringify(a))}else if(r&&o<8)k.storage=a}else{e.location.hash=c;if(r&&o<8){f=a;if(c!=k.curHash){k.document.open();k.document.write('<script>window.curHash="'+
c+'";parent.location.hash="'+c+'";window.storage='+A(f)+";<\/script>");k.document.close()}}i&&sessionStorage.setItem(n().full(),JSON.stringify(a))}if(b!=null)e.title=b;l=n().full();p=false};g.replaceState=function(a,b,c){g.pushState(a,b,c,true)}}})(window);
