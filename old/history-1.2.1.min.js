/*
 * history API JavaScript Library v1.2.1
 *
 * Copyright 2011, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 27-12-2011
 */
(function(d,y){function z(){var a=e.location.pathname;if(s){if(k!=h.basepath&&RegExp("^"+h.basepath+"$").test(a))e.location=k;if(!RegExp("^"+h.basepath).test(e.location.pathname))e.location=a.replace(/^\//,h.basepath)+e.location.search}else if(a!=h.basepath)e.location=h.basepath+"#"+a.replace(RegExp("^"+h.basepath),"/")+e.location.search+e.location.hash;return true}var s=!!(d.history&&history.pushState),e=d.document,g=null,o=false,u=true,p=[],k,m=function(a){return{url:(a||e.location.hash||"#").replace(/^#[\/]?/,
"/"),full:function(){return this.url.replace(/^\//,h.basepath)}}},h=function(){var a,b,c,f={basepath:"/",redirect:true};c=e.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){a=0;for(c=b[2].split("&");c[a];){b=c[a++].split("=");f[b[0]]=b[1]=="true"?true:b[1]=="false"?false:b[1]||""}break}if(!d.history)d.history={};g=d.history;return f}();k=m().full();if((!h.redirect||z())&&!s){g.historyAPI=s;var n=function(){for(var a=3,b=
e.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return a>4?a:false}(),q=Boolean(n);if(q&&n<8){var A=function(a){function b(f){var i=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};i.lastIndex=0;return i.test(f)?'"'+f.replace(i,function(l){var v=r[l];return typeof v===
"string"?v:"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function c(f){var i,r;switch(typeof f){case "string":return b(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";r=(i=Object.prototype.toString.apply(f)==="[object Array]")?"[":"{";for(var l in f)i&&~~l!=l||!Object.hasOwnProperty.call(f,l)||(r+=(r.length==1?"":",")+(!i&&b(l)+":"||"")+c(f[l]));return r+(i?"]":"}")}return null}return c(a)},j;
e.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');j=e.getElementById("APIHistoryFrame").contentWindow;getIframeHash=function(){return(j.curHash||"/").replace(/^\//,h.basepath)};j.curHash=m().url;j.storage=null}var B=d.addEventListener?d.addEventListener:d.attachEvent||function(){},C=d.removeEventListener?d.removeEventListener:d.detachEvent||function(){},D=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},t=function(a,b,c){if(a==="popstate"||a===
"onpopstate"){p.push(b);if(u&&!(u=false)&&k!==h.basepath&&h.redirect)setTimeout(function(){firePopState.call(d,generateLocation(k))},10)}else B(a,b,c)},w=function(a,b,c){if(a==="popstate"||a==="onpopstate"){a=0;for(c=p.length;a<c;a++)if(p[a]===b){p.splice(a,1);break}}else C(a,b,c)},x=function(a,b){var c=!b&&a.type||a;if(c==="popstate"||c==="onpopstate")for(c=p.length;0<c;){if(b=b||(typeof a=="string"?d.event:a))try{b.target=d}catch(f){try{b.srcElement=d}catch(i){}}return p[0].call(d,b)}else return D(a,
b)};if(d.addEventListener){d.addEventListener=t;d.removeEventListener=w;d.dispatchEvent=x}else{d.attachEvent=t;d.detachEvent=w;d.fireEvent=x}generateLocation=function(a){var b,c,f;f=(b=a.split("?")).shift();b=(c=b.join("?").split("#")).shift();c=c.join("#");return{hash:c?"#"+c:"",host:e.location.host,hostname:e.location.hostname,href:e.location.protocol+"//"+e.location.host+a,pathname:f,port:e.location.port,protocol:e.location.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=
function(a){g.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(k);g.state=d.JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}else if(q&&n<8)g.state=j.storage;g.title=g.state?g.state.title:null;g.state=g.state?g.state.state:null;if(g.title!=null)e.title=g.title;if(e.createEvent){b=e.createEvent("Events");b.initEvent("popstate",false,false);b.location=a;b.state=g.state;b.title=g.title;b.srcElement=d;d.dispatchEvent(b)}else if(e.createEventObject){b=e.createEventObject();b.srcElement=
d;b.location=a;b.state=g.state;b.title=g.title;b.type="popstate";d.fireEvent("popstate",b)}};hashChecker=function(){if(o)return false;o=true;var a=m().full();if(k!==a){k=a;firePopState(generateLocation(a))}o=false;return true};q&&n<8?setInterval(hashChecker,100):t((d.addEventListener?"":"on")+"hashchange",hashChecker,false);g.pushState=function(a,b,c,f){c=c==y||c==null?h.basepath:c;var i;for((i=generateLocation(m().full()).pathname.split("/")).pop();o;);o=true;c=c.replace(RegExp("^"+e.location.protocol+
"//"+e.location.hostname+"/"),"/");i=i.join("/")+"/";if(c.indexOf("/")<0)c=i+c;else if(RegExp("^"+h.basepath).test(c))c=c.replace(RegExp("^"+h.basepath),"/");else e.location=c;a={state:a,title:b};if(f){e.location.replace("#"+c);if(q&&n<8)j.curHash=c;if(d.sessionStorage&&d.JSON&&JSON.stringify){sessionStorage.removeItem(k);sessionStorage.setItem(m().full(),JSON.stringify(a))}else if(q&&n<8)j.storage=a}else{e.location.hash=c;if(q&&n<8){f=a;if(c!=j.curHash){j.document.open();j.document.write('<script>window.curHash="'+
c+'";parent.location.hash="'+c+'";window.storage='+A(f)+";<\/script>");j.document.close()}}d.sessionStorage&&d.JSON&&JSON.stringify&&a!=null&&sessionStorage.setItem(m().full(),JSON.stringify(a))}if(b!=null)e.title=b;k=m().full();o=false};g.replaceState=function(a,b,c){g.pushState(a,b,c,true)}}})(window);
