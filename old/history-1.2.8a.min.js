/*
 * history API JavaScript Library v1.2.8a IE6 Support
 *
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 01-03-2012
 */
(function(d,w){function x(){var a=g.pathname;if(r){if(i!=f.basepath&&RegExp("^"+f.basepath+"$").test(a))d.location=i;if(!RegExp("^"+f.basepath).test(a))d.location=a.replace(/^\//,f.basepath)+g.search}else if(a!=f.basepath)return d.location=f.basepath+"#"+a.replace(RegExp("^"+f.basepath),f.type)+g.search+g.hash,!1;return!0}var r=!(!d.history||!history.pushState),h=d.document,g=h.location,e=null,p=!1,t=!0,j=[],i,l=function(a){var b=g.href.split("#"),a=a||b.shift()&&"#"+b.join("#");return{url:(a||g.hash||
"#").replace(RegExp("^#[/]?(?:"+f.type+")?"),""),full:function(){return f.basepath+this.url}}},f=function(){var a,b,c,u={basepath:"/",redirect:!0,type:""};c=h.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d\w?)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){for(a=0,c=b[2].split("&");c[a];)b=c[a++].split("="),u[b[0]]="true"==b[1]?!0:"false"==b[1]?!1:b[1]||"";break}if(!d.history)d.history={};e=d.history;return u}();i=l().full();if((!f.redirect||x())&&!r){e.historyAPI=
r;var n=function(){for(var a=3,b=h.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return 4<a?a:!1}(),q=Boolean(n);if(q&&8>n){var y=function(a){function b(a){var b=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};b.lastIndex=0;return b.test(a)?'"'+a.replace(b,
function(a){var b=c[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function c(a){var d,e;switch(typeof a){case "string":return b(a);case "number":return isFinite(a)?""+a:"null";case "boolean":case "null":return""+a;case "object":if(!a)return"null";e=(d="[object Array]"===Object.prototype.toString.apply(a))?"[":"{";for(var f in a)!(d&&~~f!=f)&&Object.hasOwnProperty.call(a,f)&&(e+=(1==e.length?"":",")+(!d&&b(f)+":"||"")+c(a[f]));return e+(d?"]":
"}")}return null}return c(a)},k;h.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');k=h.getElementById("APIHistoryFrame").contentWindow;k.curHash=l().url;k.storage=null}var z=Object.defineProperty||function(a,b,c){if(a.__defineSetter__)a.__defineGetter__(b,c.get),a.__defineSetter__(b,c.set);else{var d=a[b]=c.get();setInterval(function(){a[b]!==d&&c.set(d=a[b])},1)}},A=d.addEventListener?d.addEventListener:d.attachEvent||function(){},B=d.removeEventListener?
d.removeEventListener:d.detachEvent||function(){},C=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},o=function(a,b,c){"popstate"===a||"onpopstate"===a?(j.push(b),t&&!(t=!1)&&i!==f.basepath&&f.redirect&&setTimeout(function(){firePopState.call(d,generateLocation(i))},10)):A(a,b,c)},s=function(a,b,c){if("popstate"===a||"onpopstate"===a){a=0;for(c=j.length;a<c;a++)if(j[a]===b){j.splice(a,1);break}}else B(a,b,c)},v=function(a,b){var c=!b&&a.type||a;if("popstate"===c||"onpopstate"===c)for(var b=
b||("string"==typeof a?d.event:a),c=0,e=j.length;c<e;c++){if(b)try{b.target=d}catch(f){try{b.srcElement=d}catch(g){}}j[c].call(d,b)}else return C(a,b)};d.addEventListener?(d.addEventListener=o,d.removeEventListener=s,d.dispatchEvent=v):(d.attachEvent=o,d.detachEvent=s,d.fireEvent=v);generateLocation=function(a){var u;var b,c,d;d=(b=a.split("?")).shift();u=(c=b.join("?").split("#")).shift(),b=u;c=c.join("#");return{hash:c?"#"+c:"",host:g.host,hostname:g.hostname,href:g.protocol+"//"+g.host+a,pathname:d,
port:g.port,protocol:g.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=function(a){e.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(i);e.state=d.JSON&&JSON.parse?b&&JSON.parse(b):b&&(new Function("return "+b))()}else if(q&&8>n)e.state=k.storage;e.title=e.state?e.state.title:null;e.state=e.state?e.state.state:null;if(null!=e.title)h.title=e.title;if(h.createEvent)b=h.createEvent("Events"),b.initEvent("popstate",!1,!1),b.location=a,b.state=e.state,b.title=
e.title,b.srcElement=d,d.dispatchEvent(b);else if(h.createEventObject)b=h.createEventObject(),b.srcElement=d,b.location=a,b.state=e.state,b.title=e.title,b.type="popstate",d.fireEvent("popstate",b)};hashChecker=function(){if(p)return!1;p=!0;var a=l().full();i!==a&&(i=a,firePopState(generateLocation(a)));p=!1;return!0};var m=null;z(d,"onpopstate",{set:function(a){null==a?m&&s("popstate",m,!1):"[object Function]"===Object.prototype.toString.call(a)&&o("popstate",m=a,!1)},get:function(){return m}});
q&&8>n?setInterval(hashChecker,100):o((d.addEventListener?"":"on")+"hashchange",hashChecker,!1);e.pushState=function(a,b,c,j){var c=c==w||null==c?f.basepath:c,o=d.sessionStorage&&d.JSON&&JSON.stringify,m;(m=l().url.split("/")).pop();e.state=a;e.title=b;a={state:a,title:b};for(c=c.replace(RegExp("^"+g.protocol+"//"+g.host+"/"),"/");p;);p=!0;0==c.indexOf("?")?c=f.type+l().url.replace(/\?.*$/,"")+c:0!=c.indexOf("/")?c=f.type+(0===m.length?c:m.join("/")+"/"+c):RegExp("^"+f.basepath).test(c)?c=c.replace(RegExp("^"+
f.basepath),f.type):d.location=c;if(j){d.location.replace("#"+c);if(q&&8>n)k.curHash=c;if(o)sessionStorage.removeItem(i),sessionStorage.setItem(l().full(),JSON.stringify(a));else if(q&&8>n)k.storage=a}else d.location.hash=c,q&&8>n&&(j=a,c!=k.curHash&&(k.document.open(),k.document.write('<script>window.curHash="'+c+'";parent.location.hash="'+c+'";window.storage='+y(j)+";<\/script>"),k.document.close())),o&&sessionStorage.setItem(l().full(),JSON.stringify(a));if(null!=b)h.title=b;i=l().full();p=!1};
e.replaceState=function(a,b,c){e.pushState(a,b,c,!0)}}})(window);
