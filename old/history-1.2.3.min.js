/*
 * history API JavaScript Library v1.2.3
 *
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 02-01-2012
 */
(function(d,z){function A(){var a=h.pathname;if(t){if(m!=f.basepath&&RegExp("^"+f.basepath+"$").test(a))d.location=m;if(!RegExp("^"+f.basepath).test(a))d.location=a.replace(/^\//,f.basepath)+h.search}else if(a!=f.basepath)d.location=f.basepath+"#"+a.replace(RegExp("^"+f.basepath),f.type)+h.search+h.hash;return true}var t=!!(d.history&&history.pushState),j=d.document,h=j.location,g=null,q=false,v=true,r=[],m,o=function(a){return{url:(a||h.hash||"#").replace(RegExp("^#[/]?(?:"+f.type+")?"),""),full:function(){return f.basepath+
this.url}}},f=function(){var a,b,c,e={basepath:"/",redirect:true,type:""};c=j.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){a=0;for(c=b[2].split("&");c[a];){b=c[a++].split("=");e[b[0]]=b[1]=="true"?true:b[1]=="false"?false:b[1]||""}break}if(!d.history)d.history={};g=d.history;return e}();m=o().full();if((!f.redirect||A())&&!t){g.historyAPI=t;var p=function(){for(var a=3,b=j.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML=
"<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return a>4?a:false}(),s=Boolean(p);if(s&&p<8){var B=function(a){function b(e){var i=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,k={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};i.lastIndex=0;return i.test(e)?'"'+e.replace(i,function(n){var w=k[n];return typeof w==="string"?w:"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)})+
'"':'"'+e+'"'}function c(e){var i,k;switch(typeof e){case "string":return b(e);case "number":return isFinite(e)?String(e):"null";case "boolean":case "null":return String(e);case "object":if(!e)return"null";k=(i=Object.prototype.toString.apply(e)==="[object Array]")?"[":"{";for(var n in e)i&&~~n!=n||!Object.hasOwnProperty.call(e,n)||(k+=(k.length==1?"":",")+(!i&&b(n)+":"||"")+c(e[n]));return k+(i?"]":"}")}return null}return c(a)},l;j.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');
l=j.getElementById("APIHistoryFrame").contentWindow;getIframeHash=function(){return(l.curHash||"/").replace(RegExp("^"+f.basepath),f.basepath)};l.curHash=o().url;l.storage=null}var C=d.addEventListener?d.addEventListener:d.attachEvent||function(){},D=d.removeEventListener?d.removeEventListener:d.detachEvent||function(){},E=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},u=function(a,b,c){if(a==="popstate"||a==="onpopstate"){r.push(b);if(v&&!(v=false)&&m!==f.basepath&&f.redirect)setTimeout(function(){firePopState.call(d,
generateLocation(m))},10)}else C(a,b,c)},x=function(a,b,c){if(a==="popstate"||a==="onpopstate"){a=0;for(c=r.length;a<c;a++)if(r[a]===b){r.splice(a,1);break}}else D(a,b,c)},y=function(a,b){var c=!b&&a.type||a;if(c==="popstate"||c==="onpopstate"){b=b||(typeof a=="string"?d.event:a);c=0;for(var e=r.length;c<e;c++){if(b)try{b.target=d}catch(i){try{b.srcElement=d}catch(k){}}r[c].call(d,b)}}else return E(a,b)};if(d.addEventListener){d.addEventListener=u;d.removeEventListener=x;d.dispatchEvent=y}else{d.attachEvent=
u;d.detachEvent=x;d.fireEvent=y}generateLocation=function(a){var b,c,e;e=(b=a.split("?")).shift();b=(c=b.join("?").split("#")).shift();c=c.join("#");return{hash:c?"#"+c:"",host:h.host,hostname:h.hostname,href:h.protocol+"//"+h.host+a,pathname:e,port:h.port,protocol:h.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=function(a){g.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(m);g.state=d.JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}else if(s&&
p<8)g.state=l.storage;g.title=g.state?g.state.title:null;g.state=g.state?g.state.state:null;if(g.title!=null)j.title=g.title;if(j.createEvent){b=j.createEvent("Events");b.initEvent("popstate",false,false);b.location=a;b.state=g.state;b.title=g.title;b.srcElement=d;d.dispatchEvent(b)}else if(j.createEventObject){b=j.createEventObject();b.srcElement=d;b.location=a;b.state=g.state;b.title=g.title;b.type="popstate";d.fireEvent("popstate",b)}};hashChecker=function(){if(q)return false;q=true;var a=o().full();
if(m!==a){m=a;firePopState(generateLocation(a))}q=false;return true};s&&p<8?setInterval(hashChecker,100):u((d.addEventListener?"":"on")+"hashchange",hashChecker,false);g.pushState=function(a,b,c,e){c=c==z||c==null?f.basepath:c;var i=d.sessionStorage&&d.JSON&&JSON.stringify,k;(k=o().url.split("/")).pop();a={state:a,title:b};for(c=c.replace(RegExp("^"+h.protocol+"//"+h.hostname+"/"),"/");q;);q=true;if(c.indexOf("/")!=0)c=f.type+(k.length===0?c:k.join("/")+"/"+c);else if(RegExp("^"+f.basepath).test(c))c=
c.replace(RegExp("^"+f.basepath),f.type);else d.location=c;if(e){d.location.replace("#"+c);if(s&&p<8)l.curHash=c;if(i){sessionStorage.removeItem(m);sessionStorage.setItem(o().full(),JSON.stringify(a))}else if(s&&p<8)l.storage=a}else{d.location.hash=c;if(s&&p<8){e=a;if(c!=l.curHash){l.document.open();l.document.write('<script>window.curHash="'+c+'";parent.location.hash="'+c+'";window.storage='+B(e)+";<\/script>");l.document.close()}}i&&sessionStorage.setItem(o().full(),JSON.stringify(a))}if(b!=null)j.title=
b;m=o().full();q=false};g.replaceState=function(a,b,c){g.pushState(a,b,c,true)}}})(window);
