/*
 * history API JavaScript Library v1.2
 *
 * Copyright 2011, Dmitriy Pakhtinov ( spb.piksel@gmail.com )
 *
 * http://history.spb-piksel.ru/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Update: 27-12-2011
 */
(function(d,y){function z(){var a=e.location.pathname;if(s){if(i!=g.basepath&&RegExp("^"+g.basepath+"$").test(a))e.location=i;if(!RegExp("^"+g.basepath).test(e.location.pathname))e.location=a.replace(/^\//,g.basepath)+e.location.search}else if(a!=g.basepath)e.location=g.basepath+"#"+a.replace(RegExp("^"+g.basepath),"/")+e.location.search+e.location.hash;return true}var s=!!(d.history&&history.pushState),e=d.document,j=null,o=false,u=true,p=[],i,m=function(a){return{url:(a||e.location.hash||"#").replace(/^#[\/]?/,
"/"),full:function(){return this.url.replace(/^\//,g.basepath)}}},g=function(){var a,b,c,f={basepath:"/",redirect:true};c=e.getElementsByTagName("SCRIPT");for(a=0;c[a];a++)if(b=/(.*)\/history(?:-\d\.\d(?:\.\d)?(?:\.min)?)?.js\?(.*)$/i.exec(c[a].src)){a=0;for(c=b[2].split("&");c[a];){b=c[a++].split("=");f[b[0]]=b[1]=="true"?true:b[1]=="false"?false:b[1]||""}break}if(!d.history)d.history={};j=d.history;return f}();i=m().full();if((!g.redirect||z())&&!s){j.historyAPI=s;var n=function(){for(var a=3,b=
e.createElement("div"),c=b.getElementsByTagName("i");(b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&c[0];);return a>4?a:false}(),q=Boolean(n);if(q&&n<8){var A=function(a){function b(f){var k=/[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};k.lastIndex=0;return k.test(f)?'"'+f.replace(k,function(l){var v=r[l];return typeof v===
"string"?v:"\\u"+("0000"+l.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function c(f){var k,r;switch(typeof f){case "string":return b(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);case "object":if(!f)return"null";r=(k=Object.prototype.toString.apply(f)==="[object Array]")?"[":"{";for(var l in f)k&&~~l!=l||!Object.hasOwnProperty.call(f,l)||(r+=(r.length==1?"":",")+(!k&&b(l)+":"||"")+c(f[l]));return r+(k?"]":"}")}return null}return c(a)},h;
e.write('<iframe id="APIHistoryFrame" style="display:none;" src="javascript:true;"></iframe>');h=e.getElementById("APIHistoryFrame").contentWindow;getIframeHash=function(){return(h.curHash||"/").replace(/^\//,g.basepath)};h.curHash=m().url;h.storage=null}var B=d.addEventListener?d.addEventListener:d.attachEvent||function(){},C=d.removeEventListener?d.removeEventListener:d.detachEvent||function(){},D=d.dispatchEvent?d.dispatchEvent:d.fireEvent||function(){},t=function(a,b,c){if(a==="popstate"||a===
"onpopstate"){p.push(b);if(u&&!(u=false)&&i!==g.basepath&&g.redirect)setTimeout(function(){firePopState.call(d,generateLocation(i))},10)}else B(a,b,c)},w=function(a,b,c){if(a==="popstate"||a==="onpopstate"){a=0;for(c=p.length;a<c;a++)if(p[a]===b){p.splice(a,1);break}}else C(a,b,c)},x=function(a,b){var c=!b&&a.type||a;if(c==="popstate"||c==="onpopstate")for(c=p.length;0<c;){if(b=b||(typeof a=="string"?d.event:a))try{b.target=d}catch(f){try{b.srcElement=d}catch(k){}}return p[0].call(d,b)}else return D(a,
b)};if(d.addEventListener){d.addEventListener=t;d.removeEventListener=w;d.dispatchEvent=x}else{d.attachEvent=t;d.detachEvent=w;d.fireEvent=x}generateLocation=function(a){var b,c,f;f=(b=a.split("?")).shift();b=(c=b.join("?").split("#")).shift();c=c.join("#");return{hash:c?"#"+c:"",host:e.location.host,hostname:e.location.hostname,href:e.location.protocol+"//"+e.location.host+a,pathname:f,port:e.location.port,protocol:e.location.protocol,search:b?"?"+b:"",toString:function(){return this.href}}};firePopState=
function(a){j.state=null;if(d.sessionStorage){var b=sessionStorage.getItem(i);j.state=d.JSON&&JSON.parse?JSON.parse(b):(new Function("return "+b))()}else if(q&&n<8)j.state=h.storage;if(e.createEvent){b=e.createEvent("Events");b.initEvent("popstate",false,false);b.location=a;b.state=j.state;b.srcElement=d;d.dispatchEvent(b)}else if(e.createEventObject){b=e.createEventObject();b.srcElement=d;b.location=a;b.state=j.state;b.type="popstate";d.fireEvent("popstate",b)}};hashChecker=function(){if(o)return false;
o=true;var a=m().full();if(i!==a){i=a;firePopState(generateLocation(a))}o=false;return true};q&&n<8?setInterval(hashChecker,100):t((d.addEventListener?"":"on")+"hashchange",hashChecker,false);j.pushState=function(a,b,c,f){c=c==y||c==null?g.basepath:c;for((b=generateLocation(m().full()).pathname.split("/")).pop();o;);o=true;c=c.replace(RegExp("^"+e.location.protocol+"//"+e.location.hostname+"/"),"/");b=b.join("/")+"/";if(c.indexOf("/")<0)c=b+c;else if(RegExp("^"+g.basepath).test(c))c=c.replace(RegExp("^"+
g.basepath),"/");else e.location=c;if(f){e.location.replace("#"+c);if(q&&n<8)h.curHash=c;if(d.sessionStorage&&d.JSON&&JSON.stringify){sessionStorage.removeItem(i);sessionStorage.setItem(m().full(),JSON.stringify(a))}else if(q&&n<8)h.storage=a}else{e.location.hash=c;if(q&&n<8)if(c!=h.curHash){h.document.open();h.document.write('<script>window.curHash="'+c+'";parent.location.hash="'+c+'";window.storage='+A(a)+";<\/script>");h.document.close()}d.sessionStorage&&d.JSON&&JSON.stringify&&a!=null&&sessionStorage.setItem(m().full(),
JSON.stringify(a))}i=m().full();o=false};j.replaceState=function(a,b,c){j.pushState(a,b,c,true)}}})(window);
