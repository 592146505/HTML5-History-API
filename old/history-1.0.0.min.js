/*
 * history API JavaScript Library v1.0.0
 *
 * Copyright 2011, Dmitriy Pakhtinov
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Date: 25-08-2011
 */

(function(d){function g(a){return(a=a||e.location.hash)?String(a).replace(/^#\//,f.basepath).replace(/^#/,f.basepath):f.basepath}var q=!!(d.history&&history.pushState),n=null,e=d.document,j=false,r=true,k=[],f=function(){var a={},c,b,h="";c=e.getElementsByTagName("SCRIPT");for(b=0;c[b];b++)if(match=/(.*)\/history(?:-\d\.\d\.\d(?:\.min)?)?.js\?(.*)$/i.exec(c[b].src)){a.scriptpath=match[1]+"/";h=match[2];break}h=h.split("&");for(b=0;b<h.length;b++){c=h[b].split("=");a[c[0]]=c[1]||""}a.basepath=a.basepath||
"/";a.redirect=a.redirect||1;a.redirect=a.redirect=="true"||a.redirect==1?true:false;if(a.blank)if(a.blank.indexOf("/")!==0)a.blank=a.scriptpath+a.blank;return a}();if(!d.history)d.history={};n=d.history;if(function(){if(q){if(g()!=f.basepath&&RegExp("^"+f.basepath+"$").test(e.location.pathname)){e.location=g();return false}if(!RegExp("^"+f.basepath).test(e.location.pathname)){e.location=String(e.location.pathname).replace(/^\//,f.basepath)+e.location.search;return false}}else if(e.location.pathname!=
f.basepath&&f.redirect){e.location=f.basepath+"#"+String(e.location.pathname).replace(RegExp("^"+f.basepath),"/")+e.location.search+e.location.hash;return false}return true}()&&!q){var i=g(),l=function(){for(var a=3,c=e.createElement("div"),b=c.getElementsByTagName("i");(c.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>")&&b[0];);return a>4?a:false}(),m=Boolean(l);if(m&&l<8&&f.blank){var o;document.write('<iframe frameborder="0" id="APIHistoryFrame" style="left:-1000px;top:-1000px;width:1px;height:1px;border:0;position:absolute;" src="'+
f.blank+"?"+i+'"></iframe>');o=e.getElementById("APIHistoryFrame")}var u=d.attachEvent?d.attachEvent:d.addEventListener||function(){},v=d.detachEvent?d.detachEvent:d.removeEventListener||function(){},w=d.fireEvent?d.fireEvent:d.dispatchEvent||function(){},p=function(a,c,b){if(a==="popstate"||a==="onpopstate"){k.push(c);if(r){r=false;g()!==f.basepath&&f.redirect&&firePopState(generateLocation(g()))}}else u(a,c,b)},s=function(a,c,b){if(a==="popstate"||a==="onpopstate"){a=0;for(b=k.length;a<b;a++)if(k[a]===
c){k.splice(a,1);break}}else v(a,c,b)},t=function(a,c){var b=!c&&a.type||a;if(b==="popstate"||b==="onpopstate"){b=0;for(var h=k.length;b<h;b++)k[b](c||a)}else w(a,c)};if(d.attachEvent){d.attachEvent=p;d.detachEvent=s;d.fireEvent=t}else{d.addEventListener=p;d.removeEventListener=s;d.dispatchEvent=t}generateLocation=function(a){var c,b,h;h=(c=a.split("?")).shift();c=(b=c.join("?").split("#")).shift();b=b.join("#");return{hash:b?"#"+b:"",host:e.location.host,hostname:"his.sp",href:e.location.protocol+
"//"+e.location.host+a,pathname:h,port:e.location.port,protocol:e.location.protocol,search:c?"?"+c:"",toString:function(){return this.href}}};firePopState=function(a){if(document.createEvent){var c=document.createEvent("Events");c.initEvent("popstate",false,false);c.location=a;d.dispatchEvent(c)}else if(document.createEventObject){c=document.createEventObject();c.location=a;d.fireEvent("popstate",c)}};hashChecker=function(){if(j)return false;j=true;var a=g();if(i!==a){i=a;firePopState(generateLocation(a))}else if(m&&
l<8&&f.blank){a=o.contentWindow.document;a=String(a.location.search+a.location.hash);if(a.length==1&&a.charAt(0)=="?")a="";else if(a.length>=2&&a.charAt(0)=="?")a=a.substring(1);if(i!==a){i=a;e.location.hash=i;firePopState(generateLocation(a))}}j=false;return true};m&&l<8?setInterval(hashChecker,100):p((d.attachEvent?"on":"")+"hashchange",hashChecker,false);n.pushState=function(a,c,b){for((a=generateLocation(g()).pathname.split("/")).pop();j;);j=true;a=a.join("/")+"/";if(b.indexOf("/")<0){i=g(a+b);
e.location.hash=a+b;if(m&&l<8&&f.blank)o.src=f.blank+"?"+(a+b)}else if(RegExp("^"+f.basepath).test(b)){b=b.replace(RegExp("^"+f.basepath),"/");i=g(b);e.location.hash=b;if(m&&l<8&&f.blank)o.src=f.blank+"?"+b}else e.location=b;i=g();j=false};n.replaceState=n.pushState}})(window);
